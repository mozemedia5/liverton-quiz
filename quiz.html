<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Quiz - Liverton Quiz Championship</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-text { background: linear-gradient(45deg, #0891b2, #0e7490); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .timer-circle { stroke-dasharray: 283; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
        .option-button { transition: all 0.3s ease; }
        .option-button:hover { transform: translateY(-2px); }
        .option-selected { background: linear-gradient(45deg, #0891b2, #0e7490); border-color: #0891b2; }
        .option-correct { background: linear-gradient(45deg, #10b981, #059669); border-color: #10b981; }
        .option-incorrect { background: linear-gradient(45deg, #ef4444, #dc2626); border-color: #ef4444; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full bg-slate-900/80 backdrop-blur-md z-50 border-b border-cyan-500/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">LQ</span>
                    </div>
                    <span class="text-xl font-semibold">Liverton Quiz</span>
                </div>
                <div class="hidden md:flex space-x-8">
                    <a href="dashboard.html" class="text-white hover:text-cyan-300 transition-colors">Dashboard</a>
                    <a href="quiz.html" class="text-cyan-400 hover:text-cyan-300 transition-colors">Daily Quiz</a>
                    <a href="leaderboard.html" class="text-white hover:text-cyan-300 transition-colors">Leaderboard</a>
                    <a href="rules.html" class="text-white hover:text-cyan-300 transition-colors">Rules</a>
                    <button id="logoutBtn" class="text-white hover:text-red-300 transition-colors">Logout</button>
                </div>
            </div>
<!-- Hamburger button (mobile only) -->
<button onclick="toggleMobileMenu()" class="md:hidden text-white focus:outline-none">
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
  </svg>
</button>

        </div>
    </nav>
<!-- =====  MOBILE MENU  ===== -->
<div id="mobileMenu" class="hidden fixed inset-0 bg-slate-900/95 backdrop-blur-lg z-40">
  <div class="flex flex-col items-center justify-center h-full space-y-8 text-xl">
    <a href="dashboard.html"       class="text-cyan-400 hover:text-cyan-300" onclick="hideMobileMenu()">Dashboard</a>
    <a href="quiz.html"            class="text-white hover:text-cyan-300"   onclick="hideMobileMenu()">Daily Quiz</a>
    <a href="leaderboard.html"     class="text-white hover:text-cyan-300"   onclick="hideMobileMenu()">Leaderboard</a>
    <a href="rules.html"           class="text-white hover:text-cyan-300"   onclick="hideMobileMenu()">Rules</a>
    <button onclick="hideMobileMenu(); signOut(auth).then(() => window.location.href='index.html')" class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg text-white">Logout</button>
  </div>
  <button onclick="hideMobileMenu()" class="absolute top-6 right-6 text-white">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
  </button>
</div>

    <!-- Quiz Container -->
    <section class="pt-20 pb-8 min-h-screen">
        <div class="max-w-4xl mx-auto px-4">
            <!-- Quiz Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold gradient-text mb-2">Daily Quiz</h1>
                <p class="text-gray-300" id="quizDate"></p>
            </div>

            <!-- Quiz Progress -->
            <div class="bg-slate-800/60 backdrop-blur-sm rounded-2xl p-6 border border-cyan-500/20 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-gray-300">Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span></span>
                    <span class="text-gray-300">Score: <span id="currentScore">0</span>/30</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2">
                    <div class="bg-gradient-to-r from-cyan-500 to-blue-500 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 10%"></div>
                </div>
            </div>

            <!-- Quiz Content -->
            <div id="quizContent" class="bg-slate-800/60 backdrop-blur-sm rounded-2xl p-8 border border-cyan-500/20">
                <!-- Timer -->
                <div class="flex justify-center mb-8">
                    <div class="relative w-24 h-24">
                        <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" stroke="#374151" stroke-width="8" fill="none"/>
                            <circle cx="50" cy="50" r="45" stroke="#0891b2" stroke-width="8" fill="none" 
                                    class="timer-circle" id="timerCircle"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-2xl font-bold" id="timerText">15</span>
                        </div>
                    </div>
                </div>

                <!-- Question -->
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-semibold mb-6" id="questionText">Loading question...</h2>
                </div>

                <!-- Options -->
                <div class="grid gap-4 mb-8" id="optionsContainer">
                    <!-- Options will be dynamically generated -->
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-center space-x-4">
                    <button id="retryBtn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                        Retry Question
                    </button>
                    <button id="nextBtn" class="hidden bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                        Next Question
                    </button>
                </div>
            </div>

            <!-- Quiz Results (Hidden initially) -->
            <div id="quizResults" class="hidden bg-slate-800/60 backdrop-blur-sm rounded-2xl p-8 border border-cyan-500/20">
                <div class="text-center">
                    <h2 class="text-3xl font-bold gradient-text mb-4">Quiz Completed!</h2>
                    <div class="grid md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-slate-700/50 rounded-xl p-6">
                            <p class="text-gray-400 text-sm">Final Score</p>
                            <p class="text-3xl font-bold text-cyan-400" id="finalScore">0/30</p>
                        </div>
                        <div class="bg-slate-700/50 rounded-xl p-6">
                            <p class="text-gray-400 text-sm">Time Taken</p>
                            <p class="text-3xl font-bold text-green-400" id="totalTime">0s</p>
                        </div>
                        <div class="bg-slate-700/50 rounded-xl p-6">
                            <p class="text-gray-400 text-sm">Accuracy</p>
                            <p class="text-3xl font-bold text-yellow-400" id="accuracy">0%</p>
                        </div>
                    </div>
                    <button id="viewAnswersBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-8 py-3 rounded-lg font-semibold transition-all mr-4">
                        View Answers
                    </button>
                    <button id="backToDashboardBtn" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-all">
                        Back to Dashboard
                    </button>
                </div>
            </div>

            <!-- Answer Review (Hidden initially) -->
            <div id="answerReview" class="hidden bg-slate-800/60 backdrop-blur-sm rounded-2xl p-8 border border-cyan-500/20">
                <h3 class="text-2xl font-bold mb-6">Answer Review</h3>
                <div id="reviewContainer" class="space-y-6">
                    <!-- Review questions will be dynamically generated -->
                </div>
                <div class="text-center mt-8">
                    <button id="backToResultsBtn" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-all">
                        Back to Results
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 py-8 border-t border-slate-700">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-gray-400 mb-2">¬© 2026 Liverton Quiz Championship | ¬© Liverton Codes</p>
            <p class="text-gray-500 text-sm">Designed by Musa</p>
        </div>
    </footer>
<!--  NEW ANTI-CHEAT SCRIPT  (replaces the old block completely)  -->
<script type="module">
/* =========  original imports  ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

/* =========  config  ========= */
const firebaseConfig = {
  apiKey: "AIzaSyAvqWrEUrag34Wb92D1ixmXVCh3-HY5iB8",
  authDomain: "liverton-quiz-championship.firebaseapp.com",
  projectId: "liverton-quiz-championship",
  storageBucket: "liverton-quiz-championship.firebasestorage.app",
  messagingSenderId: "1090719692182",
  appId: "1:1090719692182:web:96920d6ba665541a6a59b7"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* =========  state  ========= */
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let score = 0;
let totalTime = 0;
let timer = null;
let timeLeft = 15;
let userAnswers = [];
let questions = [];
let attemptDocId = null;          // NEW: single attempt id for this user+quiz

/* =========  entry  ========= */
onAuthStateChanged(auth, async (user) => {
  if (!user) { window.location.href = 'login.html'; return; }
  currentUser = user;
  await loadQuiz();
});

/* =========  load quiz & questions  ========= */
async function loadQuiz() {
  try {
    const today = new Date().toISOString().split('T')[0];
    const seasonId = 'season_2026_01';

    // 1. get today‚Äôs quiz (exactly like before)
    const quizSnap = await getDocs(query(collection(db, 'quizzes'), where('seasonId', '==', seasonId), where('date', '==', today)));
    if (quizSnap.empty) { showNoQuizMessage(); return; }
    currentQuiz = { id: quizSnap.docs[0].id, ...quizSnap.docs[0].data() };

    // 2. get questions (exactly like before)
    const qSnap = await getDocs(query(collection(db, 'questions'), where('quizId', '==', currentQuiz.id), orderBy('questionNumber')));
    questions = qSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    if (!questions.length) { showNoQuizMessage(); return; }

    // 3. anti-cheat: single attempt doc (user+quiz+date)
    attemptDocId = `${currentUser.uid}_${currentQuiz.id}_${today}`;
    const attemptRef = doc(db, 'attempts', attemptDocId);
    const attemptSnap = await getDoc(attemptRef);

    if (attemptSnap.exists() && attemptSnap.data().completed) {
      showAlreadyAttemptedMessage(); return;
    }

    if (!attemptSnap.exists()) {
      // first time ‚Äì create attempt
      await setDoc(attemptRef, {
        userId: currentUser.uid,
        quizId: currentQuiz.id,
        date: today,
        completed: false,
        qIndex: 0,
        score: 0,
        totalTime: 0,
        answers: [],
        lastSeen: serverTimestamp()
      });
    } else {
      // resume ‚Äì load previous state
      const d = attemptSnap.data();
      currentQuestionIndex = d.qIndex;
      score = d.score;
      totalTime = d.totalTime;
      userAnswers = d.answers || [];
      document.getElementById('currentScore').textContent = score;
    }

    startQuiz();
  } catch (e) {
    console.error(e);
    showErrorMessage('Failed to load quiz.');
  }
}

/* =========  quiz flow  ========= */
function startQuiz() {
  document.getElementById('quizDate').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  document.getElementById('totalQuestions').textContent = questions.length;
  loadQuestion();
  keepAlive();             // heartbeat
}

function loadQuestion() {
  const q = questions[currentQuestionIndex];
  document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
  document.getElementById('questionText').textContent = q.question;
  const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
  document.getElementById('progressBar').style.width = progress + '%';

  const opts = ['A','B','C','D'].map(l => ({letter:l, text:q[`option${l}`]}));
  const container = document.getElementById('optionsContainer');
  container.innerHTML = '';
  opts.forEach((o, i) => {
    const btn = document.createElement('button');
    btn.className = 'option-button w-full p-4 bg-slate-700/50 border border-slate-600 rounded-lg text-left hover:border-cyan-500 transition-all';
    btn.innerHTML = `<div class="flex items-center space-x-4"><div class="w-8 h-8 bg-slate-600 rounded-full flex items-center justify-center font-semibold">${o.letter}</div><span>${o.text}</span></div>`;
    btn.onclick = () => selectOption(o.letter);
    container.appendChild(btn);
  });

  document.getElementById('nextBtn').classList.add('hidden');
  timeLeft = 15;
  startTimer();
}

/*  ----  RESUME-TIMER  ----  */
function startTimer() {
  clearInterval(timer);

  // 1.  read remaining seconds from Firestore (saved at every tick)
  const attemptRef = doc(db, 'attempts', attemptDocId);
  getDoc(attemptRef).then(snap => {
    if (!snap.exists()) { timeLeft = 15; } else {
      const saved = snap.data().timeLeft ?? 15;
      timeLeft = Math.max(0, saved);          // never negative
    }

    // 2.  start visual countdown
    const circumference = 2 * Math.PI * 45;
    const circle = document.getElementById('timerCircle');
    circle.style.strokeDasharray = circumference;
    circle.style.strokeDashoffset = 0;

    timer = setInterval(() => {
      timeLeft--;
      document.getElementById('timerText').textContent = timeLeft;
      const offset = circumference * (15 - timeLeft) / 15;
      circle.style.strokeDashoffset = offset;

      // 3.  save remaining seconds every second (for refresh resume)
      updateDoc(attemptRef, { timeLeft });

      if (timeLeft <= 0) { clearInterval(timer); selectOption(null); }
    }, 1000);
  });
}

async function selectOption(letter) {
  clearInterval(timer);
  document.querySelectorAll('.option-button').forEach(b => b.disabled = true);
  const q = questions[currentQuestionIndex];
  const timeSpent = 15 - timeLeft;
  /*  ----  NO POINTS IF LATE  ----  */
const timeSpent = 15 - timeLeft;
const isCorrect = letter === q.correctAnswer && timeLeft > 0;   // ‚Üê extra condition
userAnswers.push({
  questionId: q.id,
  selectedAnswer: letter,
  correctAnswer: q.correctAnswer,
  isCorrect,
  timeSpent
});
if (isCorrect) {
  score += 3;
  document.getElementById('currentScore').textContent = score;
}

  await saveAttempt();           // write state to Firestore
  document.getElementById('nextBtn').classList.remove('hidden');
}

async function saveAttempt() {
  const ref = doc(db, 'attempts', attemptDocId);
  await updateDoc(ref, {
    qIndex: currentQuestionIndex + 1,
    score,
    totalTime: totalTime + (15 - timeLeft),
    answers: userAnswers,
    lastSeen: serverTimestamp()
  });
}

function nextQuestion() {
  currentQuestionIndex++;
  totalTime += 15 - timeLeft;
  if (currentQuestionIndex >= questions.length) finishQuiz();
  else loadQuestion();
}

async function finishQuiz() {
  try {
    const ref = doc(db, 'attempts', attemptDocId);
    await updateDoc(ref, {
      completed: true,
      finishedAt: serverTimestamp()
    });
    showResults();
  } catch (e) {
    showErrorMessage('Could not save results.');
  }
}

function showResults() {
  document.getElementById('quizContent').classList.add('hidden');
  document.getElementById('quizResults').classList.remove('hidden');
  document.getElementById('finalScore').textContent = `${score}/30`;
  document.getElementById('totalTime').textContent = `${totalTime}s`;
  document.getElementById('accuracy').textContent = `${Math.round(score / 30 * 100)}%`;
}

/* =========  heartbeat / anti-tab-switch  ========= */
async function keepAlive() {
  setInterval(async () => {
    try {
      const ref = doc(db, 'attempts', attemptDocId);
      await updateDoc(ref, { lastSeen: serverTimestamp() });
    } catch (e) {
      // server unreachable ‚Äì freeze
      clearInterval(timer);
      document.querySelectorAll('.option-button').forEach(b => b.disabled = true);
      showErrorMessage('Connection lost ‚Äì quiz frozen.');
    }
  }, 5000);
}

/* =========  utility messages  ========= */
function showNoQuizMessage() {
  document.getElementById('quizContent').innerHTML = `
    <div class="text-center py-12"><div class="text-6xl mb-4">üìÖ</div><h2 class="text-2xl font-bold mb-4">No Quiz Today</h2><p class="text-gray-300 mb-6">There is no quiz scheduled for today. Please check back tomorrow!</p><a href="dashboard.html" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-all">Back to Dashboard</a></div>`;
}
function showAlreadyAttemptedMessage() {
  document.getElementById('quizContent').innerHTML = `
    <div class="text-center py-12"><div class="text-6xl mb-4">‚úÖ</div><h2 class="text-2xl font-bold mb-4">Quiz Already Completed</h2><p class="text-gray-300 mb-6">You have already completed today's quiz. Great job!</p><a href="dashboard.html" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-all">Back to Dashboard</a></div>`;
}
function showErrorMessage(msg) {
  document.getElementById('quizContent').innerHTML = `
    <div class="text-center py-12"><div class="text-6xl mb-4">‚ùå</div><h2 class="text-2xl font-bold mb-4">Error</h2><p class="text-gray-300 mb-6">${msg}</p><button onclick="location.reload()" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-all">Try Again</button></div>`;
}

/* =========  event bindings  ========= */
document.getElementById('nextBtn').addEventListener('click', nextQuestion);
document.getElementById('viewAnswersBtn').addEventListener('click', () => {
  document.getElementById('quizResults').classList.add('hidden');
  document.getElementById('answerReview').classList.remove('hidden');
  const box = document.getElementById('reviewContainer');
  box.innerHTML = '';
  questions.forEach((q, i) => {
    const ua = userAnswers[i];
    const div = document.createElement('div');
    div.className = 'bg-slate-700/50 rounded-lg p-6';
    div.innerHTML = `
      <div class="flex items-start justify-between mb-4"><h4 class="font-semibold">Question ${i + 1}</h4><span class="text-sm ${ua.isCorrect ? 'text-green-400' : 'text-red-400'}">${ua.isCorrect ? '+3 points' : '0 points'}</span></div>
      <p class="text-gray-300 mb-4">${q.question}</p>
      <div class="space-y-2">
        <div class="flex items-center space-x-2"><span class="text-sm text-gray-400">Your answer:</span><span class="text-sm ${ua.isCorrect ? 'text-green-400' : 'text-red-400'}">${ua.selectedAnswer || 'No answer'}</span></div>
        <div class="flex items-center space-x-2"><span class="text-sm text-gray-400">Correct answer:</span><span class="text-sm text-green-400">${q.correctAnswer}</span></div>
        <div class="flex items-center space-x-2"><span class="text-sm text-gray-400">Time spent:</span><span class="text-sm text-gray-300">${ua.timeSpent}s</span></div>
      </div>`;
    box.appendChild(div);
  });
});
document.getElementById('backToResultsBtn').addEventListener('click', () => {
  document.getElementById('answerReview').classList.add('hidden');
  document.getElementById('quizResults').classList.remove('hidden');
});
document.getElementById('backToDashboardBtn').addEventListener('click', () => window.location.href = 'dashboard.html');
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await signOut(auth);
  window.location.href = 'index.html';
});
/*  =====  MOBILE MENU  =====  */
window.toggleMobileMenu = function () {
  const menu = document.getElementById('mobileMenu');
  menu.classList.toggle('hidden');
};
window.hideMobileMenu = function () {
  document.getElementById('mobileMenu').classList.add('hidden');
};
/*  =====  MOBILE MENU  =====  */
window.toggleMobileMenu = function () {
  const menu = document.getElementById('mobileMenu');
  menu.classList.toggle('hidden');
};
window.hideMobileMenu = function () {
  document.getElementById('mobileMenu').classList.add('hidden');
};

</script>

</body>
</html>