<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Quiz - Liverton Quiz Championship</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-text { background: linear-gradient(45deg, #0891b2, #0e7490); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .timer-circle { stroke-dasharray: 283; stroke-dashoffset: 0; transition: stroke-dashoffset 1s linear; }
        .option-button { transition: all 0.3s ease; }
        .option-button:hover { transform: translateY(-2px); }
        .option-selected { background: linear-gradient(45deg, #0891b2, #0e7490); border-color: #0891b2; }
        .option-correct { background: linear-gradient(45deg, #10b981, #059669); border-color: #10b981; }
        .option-incorrect { background: linear-gradient(45deg, #ef4444, #dc2626); border-color: #ef4444; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white min-h-screen">
    <!-- Navigation -->
    <nav class="fixed top-0 w-full bg-slate-900/80 backdrop-blur-md z-50 border-b border-cyan-500/20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-lg flex items-center justify-center">
                        <span class="text-white font-bold text-sm">LQ</span>
                    </div>
                    <span class="text-xl font-semibold">Liverton Quiz</span>
                </div>
                <div class="hidden md:flex space-x-8">
                    <a href="dashboard.html" class="text-white hover:text-cyan-300 transition-colors">Dashboard</a>
                    <a href="quiz.html" class="text-cyan-400 hover:text-cyan-300 transition-colors">Daily Quiz</a>
                    <a href="leaderboard.html" class="text-white hover:text-cyan-300 transition-colors">Leaderboard</a>
                    <a href="rules.html" class="text-white hover:text-cyan-300 transition-colors">Rules</a>
                    <button id="logoutBtn" class="text-white hover:text-red-300 transition-colors">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Quiz Container -->
    <section class="pt-20 pb-8 min-h-screen">
        <div class="max-w-4xl mx-auto px-4">
            <!-- Quiz Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold gradient-text mb-2">Daily Quiz</h1>
                <p class="text-gray-300" id="quizDate"></p>
            </div>

            <!-- Quiz Progress -->
            <div class="bg-slate-800/60 backdrop-blur-sm rounded-2xl p-6 border border-cyan-500/20 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <span class="text-gray-300">Question <span id="currentQuestion">1</span> of <span id="totalQuestions">10</span></span>
                    <span class="text-gray-300">Score: <span id="currentScore">0</span>/30</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-2">
                    <div class="bg-gradient-to-r from-cyan-500 to-blue-500 h-2 rounded-full transition-all duration-300" id="progressBar" style="width: 10%"></div>
                </div>
            </div>

            <!-- Quiz Content -->
            <div id="quizContent" class="bg-slate-800/60 backdrop-blur-sm rounded-2xl p-8 border border-cyan-500/20">
                <!-- Timer -->
                <div class="flex justify-center mb-8">
                    <div class="relative w-24 h-24">
                        <svg class="w-24 h-24 transform -rotate-90" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" stroke="#374151" stroke-width="8" fill="none"/>
                            <circle cx="50" cy="50" r="45" stroke="#0891b2" stroke-width="8" fill="none" 
                                    class="timer-circle" id="timerCircle"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span class="text-2xl font-bold" id="timerText">15</span>
                        </div>
                    </div>
                </div>

                <!-- Question -->
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-semibold mb-6" id="questionText">Loading question...</h2>
                </div>

                <!-- Options -->
                <div class="grid gap-4 mb-8" id="optionsContainer">
                    <!-- Options will be dynamically generated -->
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-center space-x-4">
                    <button id="retryBtn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                        Retry Question
                    </button>
                    <button id="nextBtn" class="hidden bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all">
                        Next Question
                    </button>
                </div>
            </div>

            <!-- Quiz Results (Hidden initially) -->
            <div id="quizResults" class="hidden bg-slate-800/60 backdrop-blur-sm rounded-2xl p-8 border border-cyan-500/20">
                <div class="text-center">
                    <h2 class="text-3xl font-bold gradient-text mb-4">Quiz Completed!</h2>
                    <div class="grid md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-slate-700/50 rounded-xl p-6">
                            <p class="text-gray-400 text-sm">Final Score</p>
                            <p class="text-3xl font-bold text-cyan-400" id="finalScore">0/30</p>
                        </div>
                        <div class="bg-slate-700/50 rounded-xl p-6">
                            <p class="text-gray-400 text-sm">Time Taken</p>
                            <p class="text-3xl font-bold text-green-400" id="totalTime">0s</p>
                        </div>
                        <div class="bg-slate-700/50 rounded-xl p-6">
                            <p class="text-gray-400 text-sm">Accuracy</p>
                            <p class="text-3xl font-bold text-yellow-400" id="accuracy">0%</p>
                        </div>
                    </div>
                    <button id="viewAnswersBtn" class="bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white px-8 py-3 rounded-lg font-semibold transition-all mr-4">
                        View Answers
                    </button>
                    <button id="backToDashboardBtn" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-all">
                        Back to Dashboard
                    </button>
                </div>
            </div>

            <!-- Answer Review (Hidden initially) -->
            <div id="answerReview" class="hidden bg-slate-800/60 backdrop-blur-sm rounded-2xl p-8 border border-cyan-500/20">
                <h3 class="text-2xl font-bold mb-6">Answer Review</h3>
                <div id="reviewContainer" class="space-y-6">
                    <!-- Review questions will be dynamically generated -->
                </div>
                <div class="text-center mt-8">
                    <button id="backToResultsBtn" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-8 py-3 rounded-lg font-semibold transition-all">
                        Back to Results
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 py-8 border-t border-slate-700">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-gray-400 mb-2">© 2026 Liverton Quiz Championship | © Liverton Codes</p>
            <p class="text-gray-500 text-sm">Designed by Muslim Musa</p>
        </div>
    </footer>
<script type="module">
/* ============================
   FIREBASE IMPORTS (FULL & SAFE)
============================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
    getFirestore,
    collection,
    doc,
    getDoc,
    getDocs,
    setDoc,
    updateDoc,
    query,
    where,
    orderBy,
    serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
    getAuth,
    onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ============================
   FIREBASE CONFIG
============================ */
const firebaseConfig = {
            apiKey: "AIzaSyAvqWrEUrag34Wb92D1ixmXVCh3-HY5iB8",
            authDomain: "liverton-quiz-championship.firebaseapp.com",
            projectId: "liverton-quiz-championship",
            storageBucket: "liverton-quiz-championship.firebasestorage.app",
            messagingSenderId: "1090719692182",
            appId: "1:1090719692182:web:96920d6ba665541a6a59b7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);


/* ============================
   GLOBAL STATE
============================ */
let currentUser = null;
let currentQuiz = null;
let questions = [];

let currentQuestionIndex = 0;
let score = 0;
let userAnswers = [];
let timer = null;
let timeLeft = 15;
let sessionReady = false;

/* ============================
   AUTH HANDLER
============================ */
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        window.location.href = "login.html";
        return;
    }

    currentUser = user;
    await initializeQuiz();
});

/* ============================
   INITIALIZE QUIZ (ORDER MATTERS)
============================ */
async function initializeQuiz() {
    currentQuiz = await fetchTodayQuiz();
    if (!currentQuiz) {
        showNoQuizMessage();
        return;
    }

    questions = currentQuiz.questions;
    if (!questions.length) {
        showNoQuizMessage();
        return;
    }

    await loadOrCreateSession();
    sessionReady = true;

    loadQuestion();
    startTimer();
}

/* ============================
   FETCH TODAY'S QUIZ (ADMIN)
============================ */
async function fetchTodayQuiz() {
    const today = new Date().toISOString().split("T")[0];

    const q = query(
        collection(db, "dailyQuizzes"),
        where("date", "==", today),
        orderBy("createdAt", "desc") 
    );

    const snap = await getDocs(q);
    if (snap.empty) return null;

    const docSnap = snap.docs[0];
    return {
        id: docSnap.id,
        ...docSnap.data()
    };
}

/* ============================
   SESSION HANDLING (SINGLE SOURCE)
============================ */
async function loadOrCreateSession() {
    const sessionRef = doc(
        db,
        "quizSessions",
        `${currentUser.uid}_${currentQuiz.id}`
    );

    const snap = await getDoc(sessionRef);

    if (snap.exists()) {
        const data = snap.data();

        if (data.completed === true) {
            showAlreadyAttemptedMessage();
            throw new Error("Quiz already completed");
        }

        currentQuestionIndex = data.currentQuestionIndex;
        score = data.score;
        userAnswers = data.userAnswers || [];
        return;
    }

    await setDoc(sessionRef, {
        userId: currentUser.uid,
        quizId: currentQuiz.id,
        currentQuestionIndex: 0,
        score: 0,
        userAnswers: [],
        completed: false,
        startedAt: serverTimestamp(),
        lastUpdated: serverTimestamp()
    });
}

/* ============================
   SAFE SESSION UPDATE
============================ */
async function updateSession() {
    if (!sessionReady || !currentUser || !currentQuiz) return;

    const sessionRef = doc(
        db,
        "quizSessions",
        `${currentUser.uid}_${currentQuiz.id}`
    );

    await updateDoc(sessionRef, {
        currentQuestionIndex,
        score,
        userAnswers,
        lastUpdated: serverTimestamp()
    });
}

/* ============================
   LOAD QUESTION
============================ */
function loadQuestion() {
    clearInterval(timer);

    const question = questions[currentQuestionIndex];
    if (!question) {
        finishQuiz();
        return;
    }

    document.getElementById("questionText").textContent = question.question;

    const options = document.querySelectorAll(".option-btn");
    options.forEach((btn, index) => {
        btn.textContent = question.options[index];
        btn.disabled = false;
    });

    timeLeft = 15;
    document.getElementById("timer").textContent = timeLeft;
}

/* ============================
   TIMER
============================ */
function startTimer() {
    timer = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").textContent = timeLeft;

        if (timeLeft <= 0) {
            handleTimeUp();
        }
    }, 1000);
}

/* ============================
   ANSWER SELECTION
============================ */
window.selectOption = async function (index, letter) {
    clearInterval(timer);

    const question = questions[currentQuestionIndex];
    const isCorrect = letter === question.correctAnswer;

    userAnswers.push({
        questionId: question.id,
        selectedAnswer: letter,
        correctAnswer: question.correctAnswer,
        isCorrect,
        timeSpent: 15 - timeLeft
    });

    if (isCorrect) score++;

    currentQuestionIndex++;
    await updateSession();

    loadQuestion();
    startTimer();
};

/* ============================
   TIME UP
============================ */
async function handleTimeUp() {
    const question = questions[currentQuestionIndex];

    userAnswers.push({
        questionId: question.id,
        selectedAnswer: null,
        correctAnswer: question.correctAnswer,
        isCorrect: false,
        timeSpent: 15
    });

    currentQuestionIndex++;
    await updateSession();

    loadQuestion();
    startTimer();
}

/* ============================
   FINISH QUIZ
============================ */
async function finishQuiz() {
    clearInterval(timer);

    const sessionRef = doc(
        db,
        "quizSessions",
        `${currentUser.uid}_${currentQuiz.id}`
    );

    await updateDoc(sessionRef, {
        completed: true,
        finishedAt: serverTimestamp(),
        score
    });

    showResults();
}

/* ============================
   ANTI-CHEAT LAYERS
============================ */
window.addEventListener("beforeunload", (e) => {
    updateSession();
    e.preventDefault();
    e.returnValue = "";
});

document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") {
        updateSession();
    }
});

setInterval(() => {
    updateSession();
}, 10000);

/* ============================
   UI HELPERS (KEEP YOURS)
============================ */
function showResults() {}
function showAlreadyAttemptedMessage() {}
function showNoQuizMessage() {}
</script>
</body>
</html>