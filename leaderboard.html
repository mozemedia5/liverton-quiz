<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - Liverton Quiz Championship</title>
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-text { background: linear-gradient(45deg, #0891b2, #0e7490); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .rank-1 { background: linear-gradient(45deg, #fbbf24, #f59e0b); }
        .rank-2 { background: linear-gradient(45deg, #9ca3af, #6b7280); }
        .rank-3 { background: linear-gradient(45deg, #a78bfa, #8b5cf6); }
        .leaderboard-row { transition: all 0.3s ease; }
        .leaderboard-row:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white min-h-screen">
    <!-- Navigation -->
  <!-- =========  UNIVERSAL NAVIGATION  ========= -->
<nav class="fixed top-0 w-full bg-slate-900/80 backdrop-blur-md z-50 border-b border-cyan-500/20">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">

      <!-- Left: logo + brand -->
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-gradient-to-r from-cyan-400 to-blue-500 rounded-lg flex items-center justify-center">
          <span class="text-white font-bold text-sm">LQ</span>
        </div>
        <span class="text-xl font-semibold">Liverton Quiz</span>
      </div>

      <!-- Center: desktop links -->
      <div class="hidden md:flex items-center space-x-8">
        <a href="dashboard.html"    class="text-white hover:text-cyan-300 transition-colors">Dashboard</a>
        <a href="quiz.html"         class="text-white hover:text-cyan-300 transition-colors">Daily Quiz</a>
        <a href="leaderboard.html"  class="text-white hover:text-cyan-300 transition-colors">Leaderboard</a>
        <a href="rules.html"        class="text-white hover:text-cyan-300 transition-colors">Rules</a>
        <button id="logoutBtn" class="text-white hover:text-red-300 transition-colors">Logout</button>
      </div>

      <!-- Right: hamburger (mobile only) -->
      <button onclick="toggleMobileMenu()" class="md:hidden text-white focus:outline-none">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>

    </div>
  </div>
</nav>

<!-- =====  MOBILE MENU OVERLAY  ===== -->
<div id="mobileMenu" class="hidden fixed inset-0 bg-slate-900/95 backdrop-blur-lg z-40">
  <div class="flex flex-col items-center justify-center h-full space-y-8 text-xl">
    <a href="dashboard.html"   class="text-white hover:text-cyan-300" onclick="hideMobileMenu()">Dashboard</a>
    <a href="quiz.html"        class="text-white hover:text-cyan-300" onclick="hideMobileMenu()">Daily Quiz</a>
    <a href="leaderboard.html" class="text-white hover:text-cyan-300" onclick="hideMobileMenu()">Leaderboard</a>
    <a href="rules.html"       class="text-white hover:text-cyan-300" onclick="hideMobileMenu()">Rules</a>
    <button onclick="hideMobileMenu(); signOut(auth).then(()=>window.location.href='login.html')"
            class="bg-red-600 hover:bg-red-700 px-6 py-2 rounded-lg text-white">
      Logout
    </button>
  </div>
  <button onclick="hideMobileMenu()" class="absolute top-6 right-6 text-white">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>
</div>

<!-- =========  UNIVERSAL JS FOR MENU  ========= -->
<script>
  window.toggleMobileMenu = () => document.getElementById('mobileMenu').classList.toggle('hidden');
  window.hideMobileMenu   = () => document.getElementById('mobileMenu').classList.add('hidden');
</script>

    <!-- Main Content -->
    <section class="pt-20 pb-8">
        <div class="max-w-6xl mx-auto px-4">
            <!-- Header -->
            <div class="text-center mb-12">
                <h1 class="text-5xl font-bold gradient-text mb-4">Leaderboard</h1>
                <p class="text-xl text-gray-300">See how you rank against other competitors</p>
            </div>

            <!-- Stats Overview -->
            <div class="grid md:grid-cols-3 gap-6 mb-12">
                <div class="bg-slate-800/60 backdrop-blur-sm rounded-2xl p-6 border border-cyan-500/20">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-cyan-400 mb-2" id="totalParticipants">-</div>
                        <div class="text-gray-300">Total Participants</div>
                    </div>
                </div>
                <div class="bg-slate-800/60 backdrop-blur-sm rounded-2xl p-6 border border-green-500/20">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-green-400 mb-2" id="totalQuizzes">-</div>
                        <div class="text-gray-300">Quizzes Completed</div>
                    </div>
                </div>
                <div class="bg-slate-800/60 backdrop-blur-sm rounded-2xl p-6 border border-yellow-500/20">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-yellow-400 mb-2" id="averageScore">-</div>
                        <div class="text-gray-300">Average Score</div>
                    </div>
                </div>
            </div>

            <!-- Top 3 Podium -->
            <div class="bg-slate-800/60 backdrop-blur-sm rounded-2xl p-8 border border-cyan-500/20 mb-8">
                <h2 class="text-3xl font-bold text-center mb-8 gradient-text">Top Performers</h2>
                <div class="grid md:grid-cols-3 gap-6" id="topThree">
                    <!-- Top 3 will be dynamically loaded -->
                </div>
            </div>

            <!-- Full Leaderboard -->
            <div class="bg-slate-800/60 backdrop-blur-sm rounded-2xl p-8 border border-cyan-500/20">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold gradient-text">Full Rankings</h2>
                    <div class="flex items-center space-x-4">
                        <select id="seasonFilter" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/20 focus:outline-none">
                            <option value="season_2026_01">Season 2026-01</option>
                        </select>
                        <button id="refreshBtn" class="bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-700 hover:to-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-all">
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Leaderboard Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="border-b border-slate-600">
                                <th class="text-left py-4 px-4 font-semibold text-gray-300">Rank</th>
                                <th class="text-left py-4 px-4 font-semibold text-gray-300">Player</th>
                                <th class="text-center py-4 px-4 font-semibold text-gray-300">Points</th>
                                <th class="text-center py-4 px-4 font-semibold text-gray-300">Quizzes</th>
                                <th class="text-center py-4 px-4 font-semibold text-gray-300">Avg Time</th>
                                <th class="text-center py-4 px-4 font-semibold text-gray-300">Last Active</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <!-- Leaderboard rows will be dynamically loaded -->
                        </tbody>
                    </table>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto mb-4"></div>
                    <p class="text-gray-300">Loading leaderboard...</p>
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">üèÜ</div>
                    <h3 class="text-2xl font-bold mb-4">No Data Available</h3>
                    <p class="text-gray-300">No quiz results found for this season yet.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 py-8 border-t border-slate-700">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <p class="text-gray-400 mb-2">¬© 2026 Liverton Quiz Championship | ¬© Liverton Codes</p>
            <p class="text-gray-500 text-sm">Designed by Musa</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, getDoc, doc, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAvqWrEUrag34Wb92D1ixmXVCh3-HY5iB8",
            authDomain: "liverton-quiz-championship.firebaseapp.com",
            projectId: "liverton-quiz-championship",
            storageBucket: "liverton-quiz-championship.firebasestorage.app",
            messagingSenderId: "1090719692182",
            appId: "1:1090719692182:web:96920d6ba665541a6a59b7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Check authentication
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            loadLeaderboard();
        });

        // Load leaderboard data
        async function loadLeaderboard() {
            try {
  showLoading();

  /*  1.  season date range  */
  const seasonId = document.getElementById('seasonFilter').value;
  const seasonCol = await getDocs(query(collection(db, 'seasons'), where('code', '==', seasonId)));
  if (seasonCol.empty) { showEmptyState(); return; }
  const seasonDoc = seasonCol.docs[0];
  const startDate = seasonDoc.data().startDate;
  const endDate   = seasonDoc.data().endDate;

  /*  2.  aggregate attempts  */
  const attemptsSnap = await getDocs(
    query(collection(db, 'attempts'),
          where('finishedAt', '>=', startDate),
          where('finishedAt', '<=', endDate),
          where('completed', '==', true))
  );

  const board = {};                                 // userId ‚Üí stats
  attemptsSnap.forEach(d => {
    const a = d.data();
    if (!board[a.userId]) board[a.userId] = { points: 0, quizzes: 0, totalTime: 0, lastActive: null };
    board[a.userId].points    += a.score;
    board[a.userId].quizzes   += 1;
    board[a.userId].totalTime += a.totalTime;
    if (!board[a.userId].lastActive || a.finishedAt > board[a.userId].lastActive)
       board[a.userId].lastActive = a.finishedAt;
  });

  /*  3.  build array + sort  */
  const leaderboardData = [];
  for (const [userId, stat] of Object.entries(board)) {
    const userDoc = await getDoc(doc(db, 'users', userId));
    if (!userDoc.exists()) continue;
    leaderboardData.push({
      userId,
      name: userDoc.data().name,
      totalPoints: stat.points,
      quizzesTaken: stat.quizzes,
      averageTime: stat.totalTime / stat.quizzes,
      lastActive: stat.lastActive
    });
  }
  leaderboardData.sort((a, b) => b.totalPoints - a.totalPoints || a.averageTime - b.averageTime);

  /*  4.  paint page  */
  displayLeaderboard(leaderboardData);
  displayTopThree(leaderboardData.slice(0, 3));

  /*  5.  top cards numbers  */
  const participants = leaderboardData.length;
  const quizzes      = leaderboardData.reduce((s, p) => s + p.quizzesTaken, 0);
  const avgScore     = participants ? Math.round(leaderboardData.reduce((s, p) => s + p.totalPoints, 0) / participants) : 0;
  document.getElementById('totalParticipants').textContent = participants;
  document.getElementById('totalQuizzes').textContent      = quizzes;
  document.getElementById('averageScore').textContent      = avgScore;

  hideLoading();
} catch (error) {
  console.error(error);
  showError();
}

                }
             
        // Display leaderboard
        function displayLeaderboard(data) {
            const tbody = document.getElementById('leaderboardBody');
            tbody.innerHTML = '';
            
            data.forEach((player, index) => {
                const rank = index + 1;
                const row = document.createElement('tr');
                row.className = 'leaderboard-row border-b border-slate-700 hover:bg-slate-700/30';
                
                // Rank badge
                let rankBadge = '';
                if (rank === 1) rankBadge = 'ü•á';
                else if (rank === 2) rankBadge = 'ü•à';
                else if (rank === 3) rankBadge = 'ü•â';
                else rankBadge = `#${rank}`;
                
                // Last active
                const lastActive = player.lastActive ? 
                    new Date(player.lastActive).toLocaleDateString() : 'Never';
                
                row.innerHTML = `
                    <td class="py-4 px-4">
                        <span class="font-bold text-lg">${rankBadge}</span>
                    </td>
                    <td class="py-4 px-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-full flex items-center justify-center font-bold">
                                ${player.name.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="font-semibold">${player.name}</div>
                                <div class="text-sm text-gray-400">ID: ${player.userId.substring(0, 8)}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-4 px-4 text-center font-bold text-cyan-400">${player.totalPoints}</td>
                    <td class="py-4 px-4 text-center">${player.quizzesTaken}</td>
                    <td class="py-4 px-4 text-center">${Math.round(player.averageTime)}s</td>
                    <td class="py-4 px-4 text-center text-sm text-gray-400">${lastActive}</td>
                `;
                
                tbody.appendChild(row);
            });
            
            hideLoading();
        }

        // Display top 3 podium
        function displayTopThree(data) {
            const podium = document.getElementById('topThree');
            podium.innerHTML = '';
            
            const rankClasses = ['rank-1', 'rank-2', 'rank-3'];
            const rankEmojis = ['ü•á', 'ü•à', 'ü•â'];
            
            data.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = `${rankClasses[index]} rounded-2xl p-6 text-center text-white transform hover:scale-105 transition-all`;
                
                card.innerHTML = `
                    <div class="text-6xl mb-4">${rankEmojis[index]}</div>
                    <h3 class="text-xl font-bold mb-2">${player.name}</h3>
                    <div class="text-3xl font-bold mb-2">${player.totalPoints}</div>
                    <div class="text-sm opacity-90">${player.quizzesTaken} quizzes taken</div>
                    <div class="text-sm opacity-90">Avg: ${Math.round(player.averageTime)}s</div>
                `;
                
                podium.appendChild(card);
            });
            
            // Fill empty positions
            for (let i = data.length; i < 3; i++) {
                const card = document.createElement('div');
                card.className = 'bg-slate-700/50 rounded-2xl p-6 text-center text-gray-400 border-2 border-dashed border-slate-600';
                
                card.innerHTML = `
                    <div class="text-6xl mb-4">${rankEmojis[i]}</div>
                    <h3 class="text-xl font-bold mb-2">Empty</h3>
                    <div class="text-sm">No player yet</div>
                `;
                
                podium.appendChild(card);
            }
        }

        // Update stats
        function updateStats(data) {
            const totalParticipants = data.length;
            const totalQuizzes = data.reduce((sum, player) => sum + player.quizzesTaken, 0);
            const averageScore = totalParticipants > 0 ? 
                Math.round(data.reduce((sum, player) => sum + player.totalPoints, 0) / totalParticipants) : 0;
            
            document.getElementById('totalParticipants').textContent = totalParticipants;
            document.getElementById('totalQuizzes').textContent = totalQuizzes;
            document.getElementById('averageScore').textContent = averageScore;
        }

        // Loading states
        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('leaderboardBody').innerHTML = '';
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
        }

        function showEmptyState() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        function showError() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').innerHTML = `
                <div class="text-6xl mb-4">‚ùå</div>
                <h3 class="text-2xl font-bold mb-4">Error Loading Data</h3>
                <p class="text-gray-300">Failed to load leaderboard data. Please try again.</p>
            `;
            document.getElementById('emptyState').classList.remove('hidden');
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', loadLeaderboard);
        document.getElementById('seasonFilter').addEventListener('change', loadLeaderboard);

        // Logout handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Page animations
        anime({
            targets: '.bg-slate-800\\/60',
            translateY: [50, 0],
            opacity: [0, 1],
            duration: 800,
            delay: anime.stagger(100),
            easing: 'easeOutExpo'
        });

    </script>
</body>
</html>